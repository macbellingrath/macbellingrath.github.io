<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  

  <meta content="Mac Bellingrath" property="og:site_name">

  <meta content="Home" property="og:title">


  <meta content="article" property="og:type">


  <meta content="" property="og:description">


  <meta content="http://macbellingrath.com/page3/" property="og:url">




  <title>
    
      Mac Bellingrath &middot; Developer
    
  </title>


  <!-- CSS -->
  <link rel="stylesheet" href="/styles.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="Mac Bellingrath" href="/atom.xml">
</head>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48561848-2', 'auto');
  ga('send', 'pageview');

</script>

    

  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">Mac Bellingrath</a>
            
            &nbsp;&nbsp;&nbsp;
            <small><a href="/about">About</a></small>
            
            &nbsp;&nbsp;&nbsp;
            <small><a href="/archive">Archive</a></small>
            
            &nbsp;&nbsp;&nbsp;
            <small><a href="/atom.xml">Feed</a></small>
            
        </h3>
      </header>

      <main>
          
        <div class="posts">
  
  <article class="post">
    <h1 class="post-title">
      <a href="/2015/08/24/Reference-Cycles/">
        Reference Cycles
      </a>
    </h1>

    <time datetime="2015-08-24T00:00:00-04:00" class="post-date">24 Aug 2015</time>

    <p>Swift is pretty great at managing memory automatically, it uses ARC to allocate memory when it’s needed, and free it up when it isn’t. I learned more about the <em>old way</em> of doing things, before automatic reference counting, and I’m here to tell you that ARC is your friend.</p>

<h3 id="so-how-does-arc-work">So how does ARC work?</h3>
<p>The simplest explanation is that ARC automatically allocates memory when you create an instance of a reference type. ARC then keeps track of the number of properties, vars, and lets where you are referencing that instance. This way, ARC will never accidentally deallocate an instance while it’s still being used. If it did, when we tried to access the instance, its properties, or its methods, our app would crash.</p>

<h3 id="avoiding-strong-reference-cycles">Avoiding strong reference cycles</h3>
<p>One of the more complicated matters in memory management is avoiding strong reference cycles between instances. 
When you have two instances that have strong references to each-other, the reference count will never be zero, and ARC will never deallocate them. Here is an example:</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">class</span> <span class="n">Minion</span> <span class="p">{</span>
  
    <span class="k">let</span> <span class="nl">name</span><span class="p">:</span> <span class="n">String</span>
    
    <span class="k">init</span><span class="p">(</span><span class="nl">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="p">}</span>
    
    <span class="k">var</span> <span class="nl">master</span><span class="p">:</span> <span class="n">Master</span><span class="o">?</span>
    
    <span class="k">deinit</span> <span class="p">{</span>
        <span class="n">print</span><span class="p">(</span><span class="s">&quot;\(name) is being deinitialized&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="n">Master</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nl">name</span><span class="p">:</span> <span class="n">String</span>
    
    <span class="k">var</span> <span class="nl">minion</span><span class="p">:</span> <span class="n">Minion</span><span class="o">?</span>
    
    <span class="k">init</span><span class="p">(</span><span class="nl">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="p">}</span>
    <span class="k">deinit</span> <span class="p">{</span>
        <span class="n">print</span><span class="p">(</span><span class="s">&quot;Master \(name) is being deinitialized&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    
<span class="p">}</span></code></pre></div>

<p>Above, I created two classes: Minion and Master. Minion instances will have a name property and an optional Master property. Next, let’s create some instances of each class. The two variables are of optional type so that we can later assign them nil values to test if ARC deallocates them.</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">var</span> <span class="nl">bob</span><span class="p">:</span> <span class="n">Minion</span><span class="o">?</span>
<span class="n">bob</span> <span class="o">=</span> <span class="n">Minion</span><span class="p">(</span><span class="nl">name</span><span class="p">:</span> <span class="s">&quot;Bob&quot;</span><span class="p">)</span>

<span class="k">var</span> <span class="nl">scarlettOverKill</span> <span class="p">:</span> <span class="n">Master</span><span class="o">?</span>
<span class="n">scarlettOverKill</span> <span class="o">=</span> <span class="n">Master</span><span class="p">(</span><span class="nl">name</span><span class="p">:</span> <span class="s">&quot;Scarlett Overkill&quot;</span><span class="p">)</span></code></pre></div>

<p>Since the Master property is an optional, its default is nil, and likewise for the optional Minion property in Master. Now that we have our instances, we can link them together…</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">bob</span><span class="o">!</span><span class="p">.</span><span class="n">master</span> <span class="o">=</span> <span class="n">scarlettOverKill</span>
<span class="n">scarlettOverKill</span><span class="o">!</span><span class="p">.</span><span class="n">minion</span> <span class="o">=</span> <span class="n">bob</span></code></pre></div>

<p>The problem is that now, even if we do the following:</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">bob</span> <span class="o">=</span> <span class="nb">nil</span>
<span class="n">scarlettOverkill</span>  <span class="o">=</span> <span class="nb">nil</span></code></pre></div>

<p>Our deinit messages will never print because both instances still have strong references to each other.</p>

<h3 id="how-do-we-fix-memory-cycles">How do we fix memory cycles?</h3>
<p>Swift addresses the issue above by letting us tell ARC that an instance can refer to another instance without keeping its strong reference. Swift uses the two keywords, “weak” and “unowned.”</p>

<p>We use <em>weak</em> when it’s possible for the reference to become nil at some point. In our example, a minion’s master could become nil at some point.</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">class</span> <span class="n">Minion</span> <span class="p">{</span>
<span class="p">...</span>
<span class="k">weak</span> <span class="k">var</span> <span class="nl">master</span><span class="p">:</span> <span class="n">Master</span><span class="o">?</span>

<span class="p">}</span></code></pre></div>

<p>We use <em>unowned</em> when we know that the reference will always have a value. Because of this, when we use ‘unowned’ our reference can only be of a non-optional type. For argument’s sake, let’s say that minions will <strong>always have a master.</strong> With this assumption, we could write the following (changing from our example above):</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">class</span> <span class="n">Minion</span> <span class="p">{</span>
<span class="p">...</span>
<span class="kr">unowned</span> <span class="k">let</span> <span class="nl">master</span><span class="p">:</span> <span class="n">Master</span>

<span class="p">}</span></code></pre></div>

<p>In either case, if we were to set bob or scarlettOverkill to nil, our deinitialization message will now print out because ARC has deallocated them.</p>


  </article>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page4">Older</a>
  
  
    <a class="pagination-item newer" href="/page2">Newer</a>
  
</div>

          
      </main>
      <footer class="footer">
        <small>
          &copy; <time datetime="2015-09-09T11:08:50-04:00">2015</time>. All rights reserved.
        </small>
      </footer>
    </div>

  </body>
</html>

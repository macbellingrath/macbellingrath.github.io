<!DOCTYPE html>
<html>


<head>
    <!-- _includes/base.html -->



    <meta charset="utf-8">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link rel="shortcut icon" type="image/png" href="favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
    <link rel="stylesheet" type="text/css" href="http://macbellingrath.com/css/bootstrap.css">
    <link rel="stylesheet" id="ppstyle" type="text/css" href="http://macbellingrath.com/css/style.css">
    <link rel='stylesheet' href='http://macbellingrath.com/css/animate.css' /><link rel='stylesheet' href='http://macbellingrath.com/css/font-awesome.min.css'/><link rel='stylesheet' href='/css/ionicons.min.css'/><link href='http://fonts.googleapis.com/css?family=Lato:100,300,400,700,900&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
    <script src="http://macbellingrath.com/js/jquery-2.1.0.min.js"></script>
    <script src="http://macbellingrath.com/js/bootstrap.js"></script>
    <script src="http://macbellingrath.com/js/blocs.js"></script>
    <title>Mac Bellingrath</title>
</head>


  <body>
      <!-- Navigation Bloc -->
<div class="bloc l-bloc bgc-white  sticky-nav" id="nav-bloc">
	<div class="container bloc-sm">
		<nav class="navbar row">
			<div class="navbar-header">
                <!-- _includes/base.html -->



				<a class="navbar-brand" href="http://macbellingrath.com">Mac Bellingrath</a>
				<button id="nav-toggle" type="button" class="ui-navbar-toggle navbar-toggle" data-toggle="collapse" data-target=".navbar-1">
					<span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
				</button>
			</div>
			<div class="collapse navbar-collapse navbar-1">
				<ul class="site-navigation nav navbar-nav">
					<li>
						<a href="http://macbellingrath.com">Home</a>
					</li>
                    <li>
						<a href="http://macbellingrath.com/blog/index.html">Blog</a>
					</li>
                    <li>
						<a href="http://macbellingrath.com/cv.html">CV</a>
					</li>
				</ul>
			</div>
		</nav>
	</div>
</div>
<!-- Navigation Bloc END -->
     
    <div class="page-content">
      <div class="wrapper">
        <div class="page-container">
<!-- bloc-1 -->
<div class="bloc l-bloc bgc-white" id="bloc-1">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Reference Cycles</h1>
    <p class="post-meta"><time datetime="2015-08-24T00:00:00-04:00" itemprop="datePublished">Aug 24, 2015</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Swift is pretty great at managing memory automatically, it uses ARC to allocate memory when it’s needed, and free it up when it isn’t. I learned more about the <em>old way</em> of doing things, before automatic reference counting, and I’m here to tell you that ARC is your friend.</p>

<h3 id="so-how-does-arc-work">So how does ARC work?</h3>
<p>The simplest explanation is that ARC automatically allocates memory when you create an instance of a reference type. ARC then keeps track of the number of properties, vars, and lets where you are referencing that instance. This way, ARC will never accidentally deallocate an instance while it’s still being used. If it did, when we tried to access the instance, its properties, or its methods, our app would crash.</p>

<h3 id="avoiding-strong-reference-cycles">Avoiding strong reference cycles</h3>
<p>One of the more complicated matters in memory management is avoiding strong reference cycles between instances. 
When you have two instances that have strong references to each-other, the reference count will never be zero, and ARC will never deallocate them. Here is an example:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">class</span> <span class="n">Minion</span> <span class="p">{</span>
  
    <span class="k">let</span> <span class="nl">name</span><span class="p">:</span> <span class="n">String</span>
    
    <span class="k">init</span><span class="p">(</span><span class="nl">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="p">}</span>
    
    <span class="k">var</span> <span class="nl">master</span><span class="p">:</span> <span class="n">Master</span><span class="o">?</span>
    
    <span class="k">deinit</span> <span class="p">{</span>
        <span class="n">print</span><span class="p">(</span><span class="s">&quot;\(name) is being deinitialized&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="n">Master</span> <span class="p">{</span>
    
    <span class="k">let</span> <span class="nl">name</span><span class="p">:</span> <span class="n">String</span>
    
    <span class="k">var</span> <span class="nl">minion</span><span class="p">:</span> <span class="n">Minion</span><span class="o">?</span>
    
    <span class="k">init</span><span class="p">(</span><span class="nl">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="p">}</span>
    <span class="k">deinit</span> <span class="p">{</span>
        <span class="n">print</span><span class="p">(</span><span class="s">&quot;Master \(name) is being deinitialized&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    
<span class="p">}</span></code></pre></figure>

<p>Above, I created two classes: Minion and Master. Minion instances will have a name property and an optional Master property. Next, let’s create some instances of each class. The two variables are of optional type so that we can later assign them nil values to test if ARC deallocates them.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">var</span> <span class="nl">bob</span><span class="p">:</span> <span class="n">Minion</span><span class="o">?</span>
<span class="n">bob</span> <span class="o">=</span> <span class="n">Minion</span><span class="p">(</span><span class="nl">name</span><span class="p">:</span> <span class="s">&quot;Bob&quot;</span><span class="p">)</span>

<span class="k">var</span> <span class="nl">scarlettOverKill</span> <span class="p">:</span> <span class="n">Master</span><span class="o">?</span>
<span class="n">scarlettOverKill</span> <span class="o">=</span> <span class="n">Master</span><span class="p">(</span><span class="nl">name</span><span class="p">:</span> <span class="s">&quot;Scarlett Overkill&quot;</span><span class="p">)</span></code></pre></figure>

<p>Since the Master property is an optional, its default is nil, and likewise for the optional Minion property in Master. Now that we have our instances, we can link them together…</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">bob</span><span class="o">!</span><span class="p">.</span><span class="n">master</span> <span class="o">=</span> <span class="n">scarlettOverKill</span>
<span class="n">scarlettOverKill</span><span class="o">!</span><span class="p">.</span><span class="n">minion</span> <span class="o">=</span> <span class="n">bob</span></code></pre></figure>

<p>The problem is that now, even if we do the following:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">bob</span> <span class="o">=</span> <span class="nb">nil</span>
<span class="n">scarlettOverkill</span>  <span class="o">=</span> <span class="nb">nil</span></code></pre></figure>

<p>Our deinit messages will never print because both instances still have strong references to each other.</p>

<h3 id="how-do-we-fix-memory-cycles">How do we fix memory cycles?</h3>
<p>Swift addresses the issue above by letting us tell ARC that an instance can refer to another instance without keeping its strong reference. Swift uses the two keywords, “weak” and “unowned.”</p>

<p>We use <em>weak</em> when it’s possible for the reference to become nil at some point. In our example, a minion’s master could become nil at some point.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">class</span> <span class="n">Minion</span> <span class="p">{</span>
<span class="p">...</span>
<span class="k">weak</span> <span class="k">var</span> <span class="nl">master</span><span class="p">:</span> <span class="n">Master</span><span class="o">?</span>

<span class="p">}</span></code></pre></figure>

<p>We use <em>unowned</em> when we know that the reference will always have a value. Because of this, when we use ‘unowned’ our reference can only be of a non-optional type. For argument’s sake, let’s say that minions will <strong>always have a master.</strong> With this assumption, we could write the following (changing from our example above):</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">class</span> <span class="n">Minion</span> <span class="p">{</span>
<span class="p">...</span>
<span class="kr">unowned</span> <span class="k">let</span> <span class="nl">master</span><span class="p">:</span> <span class="n">Master</span>

<span class="p">}</span></code></pre></figure>

<p>In either case, if we were to set bob or scarlettOverkill to nil, our deinitialization message will now print out because ARC has deallocated them.</p>


  </div>

</article>
    </div>
</div>
      </div>
    </div>

    <footer class="site-footer">

 <div class="bloc l-bloc bgc-white" id="bloc-6">
	<div class="container bloc-sm">
		<div class="row">
			<div class="col-md-6 col-md-offset-3 col-sm-12">
				<div class="col-sm-3 text-center">
					<a class="social" href="https://twitter.com/mbellingrath"><span class="fa fa-twitter icon-md"></span></a>
				</div>
				<div class="col-sm-3 text-center">
					<a class="social" href="http://github.com/macbellingrath"><span class="fa fa-github-alt icon-md"></span></a>
				</div>
				<div class="col-sm-3 text-center">
					<a class="social" href="https://www.linkedin.com/in/mbellingrath"><span class="ion ion-social-linkedin icon-md"></span></a>
				</div>
				<div class="col-sm-3 text-center">
					<a class "social" href="mailto: hello@macbellingrath.com?Subject=Hello%20Mac" target="_blank"><span class="ion ion-android-mail icon icon-mail icon-md"></span>
                    
                    </a>
					</div>
				</div>
			</div>
		</div>
	</div>

</footer>


  </body>

</html>
